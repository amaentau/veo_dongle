# üöÄ Azure Deployment Guide for Espa-TV BBS

## Prerequisites

- Azure subscription (free tier available)
- Azure CLI installed (`az login`)
- Node.js 22+ installed locally
- WSL (recommended for bash scripts)

## üõ†Ô∏è Option 1: Automated Infrastructure Setup (Recommended)

This script will create the Resource Group, Storage Account (Table Storage), IoT Hub, and App Service in one go.

### Using Bash (WSL/Linux/Mac)
```bash
chmod +x azure-web-setup.sh
./azure-web-setup.sh
```

### Using PowerShell (Windows)
```powershell
.\azure-web-setup.ps1
```

## üì¶ Option 2: Deploying the BBS Code

Once the infrastructure is ready, you can deploy the code from the `bbs/` directory.

### Step 1: Prepare the deployment zip
In your WSL terminal:
```bash
cd bbs
rm -f deploy.zip
zip -qr deploy.zip . -x "node_modules/*" ".git/*" "*.env" "*.env.template" "deploy.zip"
```

### Step 2: Push to Azure
```bash
az webapp deployment source config-zip \
  --name <YOUR_APP_NAME> \
  --resource-group EspaTvResourceGroup \
  --src deploy.zip
```
*(Replace `<YOUR_APP_NAME>` with the name generated by the setup script)*

## ‚öôÔ∏è Configuration

The BBS service requires the following Environment Variables in the Azure App Service (automatically set by the setup scripts):

- `STORAGE_CONNECTION_STRING`: Connection to Azure Table Storage.
- `IOT_HUB_NAME`: The name of your IoT Hub.
- `IOT_HUB_RESOURCE_GROUP`: The resource group where IoT Hub lives.
- `IOT_HUB_SUBSCRIPTION_ID`: Your Azure Subscription ID.
- `JWT_SECRET`: (Set manually) A long random string for user sessions.
- `BREVO_SMTP_KEY`: (Set manually) For sending OTP emails.

## üîç Troubleshooting

### Commands Not Reaching Device
1. Check `az webapp log tail --name <YOUR_APP_NAME> --resource-group EspaTvResourceGroup`.
2. Ensure the Raspberry Pi is "Online" in the Web UI.
3. Verify the App Service Managed Identity has **IoT Hub Data Contributor** role.

### Deployment 502/400 Errors
- Ensure `SCM_COMMAND_IDLE_TIMEOUT` is set to `600` in App Settings.
- Ensure `SCM_DO_BUILD_DURING_DEPLOYMENT` is `true`.

## üí∞ Cost Optimization (Free Tier)
- **IoT Hub (F1)**: 8,000 messages/day (Free).
- **App Service (F1/B1)**: Free or low cost.
- **Storage (LRS)**: Pay-as-you-go (very low for Table Storage).
