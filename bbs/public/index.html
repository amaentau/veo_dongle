<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ESPA TV Remote</title>
  <style>
    :root {
      --primary-color: #157039; /* Official Brand Green */
      --primary-hover: #0a4f25;
      --accent-color: #FCE354; /* Official Brand Yellow */
      --bg-color: #fcfcf0;
      --card-bg: #ffffff;
      --text-main: #323130;
      --text-sub: #605e5c;
      --border-color: #e1dfdd;
      --radius: 8px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      align-items: center; /* Center vertically for auth screen */
    }

    .container {
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      transition: opacity 0.3s ease;
    }

    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.4s ease-out; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    header {
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .logo {
      height: 80px;
      width: auto;
      object-fit: contain;
    }

    h1 {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text-main);
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(21, 112, 57, 0.1);
    }

    /* PIN Code Input specific */
    input.pin-input {
      letter-spacing: 0.5em;
      font-family: monospace;
      font-size: 24px;
      text-align: center;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-top: 8px;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    button:disabled {
      background-color: #a0c4b0;
      cursor: wait;
    }

    button.link-btn {
      background: none;
      color: var(--primary-color);
      text-decoration: underline;
      padding: 8px;
      margin-top: 4px;
      font-size: 14px;
      font-weight: normal;
    }
    button.link-btn:hover { background: none; color: var(--primary-hover); }

    .status-msg {
      margin-top: 12px;
      font-size: 14px;
      text-align: center;
      min-height: 20px;
    }
    .status-msg.success { color: green; }
    .status-msg.error { color: #d13438; }

    /* App Mode Styles */
    .app-header { margin-top: 0; }
    .history-section { margin-top: 10px; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    h3 { font-size: 18px; margin: 0; font-weight: 600; }
    
    .refresh-btn {
      background: none; color: var(--primary-color); border: none; padding: 0; 
      font-size: 14px; cursor: pointer; width: auto; margin: 0; font-weight: normal;
    }
    .refresh-btn:hover { text-decoration: underline; background: none; }

    ul.history-list { list-style: none; padding: 0; margin: 0; }
    li.history-item {
      background: var(--card-bg); border-radius: var(--radius); padding: 16px; margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid transparent; transition: border-color 0.2s;
    }
    li.history-item:hover { border-color: var(--border-color); }
    
    .item-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .item-title { font-weight: 600; font-size: 16px; color: var(--text-main); }
    .item-time { font-size: 12px; color: var(--text-sub); white-space: nowrap; margin-left: 8px; }
    .item-url { font-size: 13px; color: var(--primary-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; text-decoration: none; }
    
    .empty-state { text-align: center; color: var(--text-sub); font-style: italic; margin-top: 20px; }
    
    .loader {
      border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%;
      width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 20px auto; display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .user-info {
      text-align: center;
      margin-bottom: 16px;
      font-size: 14px;
      color: var(--text-sub);
    }
    .logout-btn {
      font-size: 12px;
      color: var(--text-sub);
      text-decoration: underline;
      cursor: pointer;
      margin-left: 8px;
    }
    
    /* Admin Inputs */
    .admin-input {
      padding: 6px;
      font-size: 14px;
    }

    /* Scoreboard Toggle */
    .toggle-btn {
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .toggle-btn.active {
      background-color: var(--primary-color) !important;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px var(--primary-color);
    }
    
    /* Event Badges */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      margin-right: 4px;
      color: white;
    }
    .badge-treenipeli { background-color: #6c757d; }
    .badge-winterliiga { background-color: #007bff; }
    .badge-futsal { background-color: #fd7e14; }
    .badge-mcdonaldsliiga { background-color: #ffc107; color: black; }
    
    .score-edit-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      padding: 4px;
      color: var(--text-sub);
    }
    .score-edit-btn:hover { color: var(--primary-color); }

    /* Admin Tabs */
    .tab-btn {
      background: none;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-sub);
      border-bottom: 2px solid transparent;
      width: auto;
      margin: 0;
    }
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: bold;
    }
    .admin-tab { padding: 10px 0; }
  </style>
  <script defer src="/script.js"></script>
  <script>
    window.APP_CONFIG = { baseUrl: '' };
  </script>
</head>
<body>

  <!-- AUTH CONTAINER -->
  <main id="authContainer" class="container">
    <header>
      <img src="/logo.png" alt="EsPa Logo" class="logo">
      <h1>ESPA TV</h1>
    </header>

    <div class="card">
      <!-- Step 1: Lookup Email -->
      <div id="stepLookup">
        <div class="form-group">
          <label for="authEmail">S√§hk√∂posti</label>
          <input id="authEmail" type="email" placeholder="nimi@espa.fi" autofocus>
        </div>
        <button id="btnLookup">Jatka</button>
      </div>

      <!-- Step 2: OTP (New/Reset) -->
      <div id="stepOtp" class="hidden">
        <p style="text-align:center; margin-bottom:16px;">
          L√§hetimme vahvistuskoodin osoitteeseen <strong id="displayEmailOtp"></strong>
        </p>
        <div class="form-group">
          <label for="authOtp">Vahvistuskoodi (6 numeroa)</label>
          <input id="authOtp" type="text" class="pin-input" placeholder="123456" maxlength="6">
        </div>
        <button id="btnVerifyOtp">Vahvista</button>
        <button class="link-btn" id="btnBackToLookup">Vaihda s√§hk√∂posti</button>
      </div>

      <!-- Step 3: Set PIN -->
      <div id="stepSetPin" class="hidden">
        <p style="text-align:center; margin-bottom:16px;">Luo uusi 4-numeroinen PIN-koodi.</p>
        <div class="form-group">
          <label for="authSetPin">Uusi PIN</label>
          <input id="authSetPin" type="password" class="pin-input" placeholder="****" maxlength="4">
        </div>
        <button id="btnSetPin">Tallenna PIN</button>
      </div>

      <!-- Step 4: Login PIN -->
      <div id="stepLogin" class="hidden">
        <p style="text-align:center; margin-bottom:16px;">
          Tervetuloa takaisin, <strong id="displayEmailLogin"></strong>
        </p>
        <div class="form-group">
          <label for="authLoginPin">Sy√∂t√§ PIN-koodi</label>
          <input id="authLoginPin" type="password" class="pin-input" placeholder="****" maxlength="4" autofocus>
        </div>
        <button id="btnLogin">Kirjaudu</button>
        <button class="link-btn" id="btnForgotPin">Unohdin PIN-koodin</button>
        <button class="link-btn" id="btnBackToLookup2">Vaihda k√§ytt√§j√§√§</button>
      </div>

      <div id="authStatus" class="status-msg"></div>
    </div>
  </main>

  <!-- APP CONTAINER (Hidden initially) -->
  <main id="appContainer" class="container hidden">
    <header class="app-header">
      <img src="/logo.png" alt="EsPa Logo" class="logo" style="height:60px;">
      <h1 style="font-size:24px;">ESPA TV</h1>
    </header>

    <div class="user-info">
      Kirjautuneena: <span id="currentUserEmail"></span>
      <span class="logout-btn" id="btnLogout">Kirjaudu ulos</span>
    </div>

    <!-- Admin Button -->
    <div id="adminControls" style="text-align:center; margin-bottom:16px; display:none;">
      <button id="btnOpenAdmin" style="width:auto; padding:8px 16px; font-size:14px; background-color:#605e5c;">
        üîß J√§rjestelm√§n asetukset
      </button>
    </div>

    <div class="card">
      <div class="form-group">
        <label for="deviceSelect">Valitse laite</label>
        <div style="display:flex; gap:8px;">
          <select id="deviceSelect" style="flex:1; padding:12px; border-radius:4px; border:1px solid var(--border-color); font-size:16px; background-color:white;">
            <option value="">Ladataan laitteita...</option>
          </select>
          <button id="btnOpenRename" title="Nime√§ uudelleen" style="width:48px; margin-top:0; padding:0; font-size:18px; line-height:1; display:none; align-items:center; justify-content:center; background-color:var(--text-sub);">‚úèÔ∏è</button>
          <button id="btnOpenShare" title="Jaa k√§ytt√∂oikeus" style="width:48px; margin-top:0; padding:0; font-size:20px; line-height:1; display:none; align-items:center; justify-content:center; background-color:var(--text-sub);">üë•</button>
          <button id="btnOpenClaim" title="Lis√§√§ uusi laite" style="width:48px; margin-top:0; padding:0; font-size:24px; line-height:1; display:flex; align-items:center; justify-content:center;">+</button>
        </div>
      </div>

      <div class="form-group">
        <label for="videoUrl">Videon osoite (URL)</label>
        <input id="videoUrl" type="url" placeholder="https://youtube.com/...">
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="form-group">
          <label for="gameGroup">Peliryhm√§</label>
          <select id="gameGroup" style="width:100%; padding:12px; border-radius:4px; border:1px solid var(--border-color); font-size:16px;">
            <option value="">Ladataan...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="eventType">Tapahtuma</label>
          <select id="eventType" style="width:100%; padding:12px; border-radius:4px; border:1px solid var(--border-color); font-size:16px;">
            <option value="">Ladataan...</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="opponent">Vastustaja</label>
        <input id="opponent" type="text" placeholder="esim. Kirkkonummi">
      </div>

      <div class="form-group">
        <label>Tulos & Paikka</label>
        <div style="display:flex; flex-direction:column; gap:12px; padding:12px; background:#f5f5f5; border-radius:8px; border:1px solid var(--border-color);">
          <div style="display:flex; justify-content:center; gap:8px;">
            <button id="btnHome" class="toggle-btn active" style="width:auto; padding:6px 16px; margin:0; font-size:14px;">Koti</button>
            <button id="btnAway" class="toggle-btn" style="width:auto; padding:6px 16px; margin:0; font-size:14px; background-color:var(--text-sub);">Vieras</button>
          </div>
          
          <div style="display:flex; align-items:center; justify-content:center; gap:12px; font-weight:bold;">
            <div id="teamLeftLabel" style="flex:1; text-align:right; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">EsPa</div>
            <input id="scoreHome" type="number" placeholder="-" style="width:50px; text-align:center; padding:8px;">
            <span>‚Äî</span>
            <input id="scoreAway" type="number" placeholder="-" style="width:50px; text-align:center; padding:8px;">
            <div id="teamRightLabel" style="flex:1; text-align:left; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Vastustaja</div>
          </div>
        </div>
      </div>

      <div class="form-group" style="display:none;">
        <label for="videoTitle">Otsikko <span style="font-weight:normal; color:var(--text-sub)">(Valinnainen)</span></label>
        <input id="videoTitle" type="text" placeholder="esim. Luontodokumentti">
      </div>

      <div class="form-group">
        <label>L√§het√§ laitteille:</label>
        <div id="deviceCheckboxList" style="max-height:150px; overflow-y:auto; border:1px solid var(--border-color); border-radius:4px; padding:8px; background-color:#fafafa; display:flex; flex-direction:column; gap:6px;">
          <!-- Checkboxes injected here -->
        </div>
        <button id="btnSelectAllDevices" class="link-btn" style="text-align:left; padding:4px 0; margin:0;">Valitse kaikki</button>
      </div>

      <button id="sendBtn">Lis√§√§ soittolistalle</button>
      <div id="statusMsg" class="status-msg"></div>
    </div>

    <!-- IoT Controls Card -->
    <div id="iotControlsContainer" class="card hidden">
      <h3 style="margin-top:0; color:var(--primary-color); display:flex; justify-content:space-between; align-items:center;">
        IoT Ohjaimet
        <span id="iotStatusBadge" style="font-size:12px; padding:2px 8px; border-radius:10px; background:#eee; color:#666; font-weight:normal;">Ladataan...</span>
      </h3>
      
      <!-- Not Registered State -->
      <div id="iotNotRegistered" class="hidden" style="text-align:center; padding:10px 0;">
        <p style="font-size:14px; color:var(--text-sub); margin-bottom:12px;">Laitetta ei ole rekister√∂ity IoT Hubiin.</p>
        <button id="btnRegisterIoT" style="width:auto; padding:8px 16px;">Aktivoi IoT-ohjaus</button>
      </div>

      <!-- Control Buttons -->
      <div id="iotButtons" class="hidden">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
          <button id="btnIotPlay" style="background-color:var(--primary-color); padding: 10px 5px;">‚ñ∂Ô∏è Toista</button>
          <button id="btnIotPause" style="background-color:var(--text-sub); padding: 10px 5px;">‚è∏Ô∏è Tauko</button>
          <button id="btnIotFullscreen" style="background-color:var(--text-sub); padding: 10px 5px;">üì∫ Koko n√§ytt√∂</button>
          <button id="btnIotRestart" style="background-color:#d13438; padding: 10px 5px;">üîÑ Restart Pi</button>
        </div>
        <button id="btnIotStatus" class="link-btn" style="text-align:left; padding:4px 0; margin:0;">P√§ivit√§ laitteen tila</button>
      </div>

      <div id="iotStatusMsg" class="status-msg" style="font-size:12px; margin-top:8px;"></div>
    </div>

    <div class="history-section">
      <div class="history-header">
        <h3>Viimeisimm√§t</h3>
        <button id="refreshBtn" class="refresh-btn">P√§ivit√§</button>
      </div>
      <div id="loader" class="loader"></div>
      <ul id="historyList" class="history-list">
        <!-- Items will be injected here -->
      </ul>
      <div id="emptyState" class="empty-state" style="display:none">Ei viimeaikaisia kohteita.</div>
    </div>
  </main>

  <!-- ADMIN MODAL -->
  <div id="adminModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
    <div class="card" style="width:95%; max-width:600px; max-height:90vh; overflow-y:auto;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; color:var(--primary-color);">J√§rjestelm√§n hallinta</h2>
        <button id="btnCloseAdmin" style="width:auto; margin:0; padding:4px 12px; background-color:var(--text-sub);">X</button>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid var(--border-color); padding-bottom:10px;">
        <button class="tab-btn active" data-tab="tabCoords">Koordinaatit</button>
        <button class="tab-btn" data-tab="tabMetadata">Metadata</button>
        <button class="tab-btn" data-tab="tabUsers">K√§ytt√§j√§t</button>
      </div>
      
      <!-- Coordinates Tab -->
      <div id="tabCoords" class="admin-tab">
        <p style="font-size:13px; color:var(--text-sub);">Muokkaa Veo-soittimen klikkauskohtia eri resoluutioille.</p>
        <div id="adminConfigForm"></div>
        <button id="btnSaveAdmin" style="margin-top:10px;">Tallenna koordinaatit</button>
      </div>

      <!-- Metadata Tab -->
      <div id="tabMetadata" class="admin-tab hidden">
        <h3 style="font-size:16px; margin-bottom:10px;">Peliryhm√§t ja Tapahtumatyypit</h3>
        
        <div style="margin-bottom:20px;">
          <label>Peliryhm√§t (pilkulla erotettuna)</label>
          <textarea id="adminGameGroups" style="width:100%; height:60px; padding:8px; border-radius:4px; border:1px solid var(--border-color);"></textarea>
        </div>

        <div style="margin-bottom:20px;">
          <label>Tapahtumatyypit (pilkulla erotettuna)</label>
          <textarea id="adminEventTypes" style="width:100%; height:60px; padding:8px; border-radius:4px; border:1px solid var(--border-color);"></textarea>
        </div>
        
        <button id="btnSaveMetadata">Tallenna metadata</button>
      </div>

      <!-- Users Tab -->
      <div id="tabUsers" class="admin-tab hidden">
        <h3 style="font-size:16px; margin-bottom:10px;">K√§ytt√§j√§hallinta</h3>
        <div id="adminUsersList" style="max-height:300px; overflow-y:auto; border:1px solid var(--border-color); border-radius:4px;">
          <!-- Users injected here -->
        </div>
      </div>

      <div class="status-msg" id="adminStatus"></div>
    </div>
  </div>

  <!-- CLAIM DEVICE MODAL -->
  <div id="claimModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
    <div class="card" style="width:90%; max-width:400px;">
      <h2 style="margin-top:0; color:var(--primary-color);">Lis√§√§ laite</h2>
      <p style="font-size:13px; color:var(--text-sub);">Yhdist√§ uusi ESPA TV -soitin tiliisi.</p>
      
      <div class="form-group">
        <label for="claimDeviceId">Laitteen tunnus</label>
        <input id="claimDeviceId" type="text" placeholder="esim. rpi-1234">
      </div>
      <div class="form-group">
        <label for="claimFriendlyName">Laitteen nimi</label>
        <input id="claimFriendlyName" type="text" placeholder="esim. Makuuhuone">
      </div>

      <div class="status-msg" id="claimStatus"></div>
      
      <div style="display:flex; gap:12px; margin-top:20px;">
        <button id="btnCloseClaim" style="background-color:var(--text-sub);">Peruuta</button>
        <button id="btnSaveClaim">Lis√§√§</button>
      </div>
    </div>
  </div>

  <!-- SHARE MODAL -->
  <div id="shareModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
    <div class="card" style="width:90%; max-width:400px;">
      <h2 style="margin-top:0; color:var(--primary-color);">Jaa laite</h2>
      <p style="font-size:13px; color:var(--text-sub);">Anna muille k√§ytt√§jille oikeus lis√§t√§ videoita laitteelle <strong id="shareDeviceName"></strong>.</p>
      
      <div class="form-group" style="display:flex; gap:8px;">
        <input id="shareEmailInput" type="email" placeholder="nimi@espa.fi" style="flex:1;">
        <button id="btnDoShare" style="width:auto; margin-top:0; padding:8px 16px;">Lis√§√§</button>
      </div>

      <div id="shareStatus" class="status-msg"></div>

      <h3 style="font-size:14px; margin-bottom:8px; margin-top:16px;">K√§ytt√∂oikeudet:</h3>
      <ul id="shareList" style="list-style:none; padding:0; margin:0; max-height:200px; overflow-y:auto; border:1px solid var(--border-color); border-radius:4px;">
        <!-- Share items injected here -->
      </ul>
      
      <div style="margin-top:20px; display:flex; flex-direction:column; gap:8px;">
        <button id="btnCloseShare" style="background-color:var(--text-sub);">Sulje</button>
        <button id="btnReleaseDevice" style="background-color:#d13438; font-size:13px; margin-top:12px;">‚ö†Ô∏è Vapauta laite (Poista kaikki oikeudet)</button>
      </div>
    </div>
  </div>

  <!-- RENAME MODAL -->
  <div id="renameModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
    <div class="card" style="width:90%; max-width:400px;">
      <h2 style="margin-top:0; color:var(--primary-color);">Nime√§ laite</h2>
      <p style="font-size:13px; color:var(--text-sub);">Anna laitteelle tunnistettava nimi.</p>
      
      <div class="form-group">
        <label for="renameFriendlyName">Laitteen nimi</label>
        <input id="renameFriendlyName" type="text" placeholder="esim. Makuuhuone">
      </div>

      <div class="status-msg" id="renameStatus"></div>
      
      <div style="display:flex; gap:12px; margin-top:20px;">
        <button id="btnCloseRename" style="background-color:var(--text-sub);">Peruuta</button>
        <button id="btnSaveRename">Tallenna</button>
      </div>
    </div>
  </div>

</body>
</html>
